<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Flow AI - Client Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #212529;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.7);
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        .sidebar .nav-link:hover {
            color: rgba(255, 255, 255, 1);
        }
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link i {
            margin-right: 0.5rem;
        }
        .main-content {
            padding: 2rem;
        }
        .dashboard-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .dashboard-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #0d6efd;
        }
        .stock-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: transform 0.2s;
            border: 1px solid #e0e0e0;
        }
        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .positive {
            color: #198754;
        }
        .negative {
            color: #dc3545;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .badge-sector {
            background-color: #6c757d;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .chart-container {
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <div class="d-flex flex-column h-100">
                    <div class="p-3 text-center">
                        <h3>Stock Flow AI</h3>
                        <p class="mb-0">Client Portal</p>
                    </div>
                    <hr class="text-white mt-0">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="stock-analysis.html">
                                <i class="bi bi-graph-up"></i> Stock Analysis
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="pdf-analysis.html">
                                <i class="bi bi-file-earmark-text"></i> PDF Analysis
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="cart.html">
                                <i class="bi bi-cart"></i> Cart
                                <span class="badge bg-primary rounded-pill" id="cart-badge">3</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="chat-nav-link">
                                <i class="bi bi-chat-dots"></i> Chat with Admin
                                <span id="unread-badge" class="badge bg-danger ms-2 d-none">0</span>
                            </a>
                        </li>
                    </ul>
                    <div class="mt-auto p-3">
                        <button id="logout-btn" class="btn btn-outline-light w-100">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
            <!-- Main Content -->
            <div class="col-md-10 main-content">
                <h2 class="mb-4">Your Portfolio Dashboard</h2>
                
                <!-- Portfolio Summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="dashboard-card text-center">
                            <h3>Total Portfolio Value</h3>
                            <h2 class="mb-0">$42,851.75</h2>
                            <p class="positive"><i class="bi bi-arrow-up"></i> 2.8% today</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-card text-center">
                            <h3>Day's Gain/Loss</h3>
                            <h2 class="mb-0 positive">+$1,172.50</h2>
                            <p>Based on closing prices</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-card text-center">
                            <h3>Total Stocks</h3>
                            <h2 class="mb-0">5</h2>
                            <p>Across 4 sectors</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-card text-center">
                            <h3>Approval Status</h3>
                            <span class="badge bg-success fs-6">Approved</span>
                            <p class="mt-2">All trade requests allowed</p>
                        </div>
                    </div>
                </div>
                
                <!-- Main Dashboard Content -->
                <div class="row">
                    <!-- Stock Holdings -->
                    <div class="col-md-8">
                        <div class="dashboard-card">
                            <h3><i class="bi bi-briefcase-fill me-2"></i> Your Stock Holdings</h3>
                            <!-- Stock Cards Container -->
                            <div class="row" id="stocks-container">
                                <!-- Stock cards will be dynamically added here -->
                                <div class="col-md-6 mb-3">
                                    <div class="stock-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h4 class="card-title">AAPL</h4>
                                                <p class="mb-1">Apple Inc.</p>
                                                <span class="badge-sector">Technology</span>
                                            </div>
                                            <h4>$178.72 <span class="positive">+1.2%</span></h4>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="mb-1"><small>Shares: <strong>10</strong></small></p>
                                                <p class="mb-1"><small>Total Value: <strong>$1,787.20</strong></small></p>
                                                <p class="mb-1"><small>Avg. Cost: <strong>$162.50</strong></small></p>
                                                <p class="mb-0 positive"><small>Return: <strong>+10.0%</strong></small></p>
                                            </div>
                                            <div class="d-flex align-items-end">
                                                <button class="btn btn-outline-danger sell-btn" data-symbol="AAPL" data-price="178.72">
                                                    <i class="bi bi-graph-down-arrow"></i> Sell
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="stock-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h4 class="card-title">MSFT</h4>
                                                <p class="mb-1">Microsoft Corporation</p>
                                                <span class="badge-sector">Technology</span>
                                            </div>
                                            <h4>$417.88 <span class="positive">+0.7%</span></h4>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="mb-1"><small>Shares: <strong>5</strong></small></p>
                                                <p class="mb-1"><small>Total Value: <strong>$2,089.40</strong></small></p>
                                                <p class="mb-1"><small>Avg. Cost: <strong>$380.50</strong></small></p>
                                                <p class="mb-0 positive"><small>Return: <strong>+9.8%</strong></small></p>
                                            </div>
                                            <div class="d-flex align-items-end">
                                                <button class="btn btn-outline-danger sell-btn" data-symbol="MSFT" data-price="417.88">
                                                    <i class="bi bi-graph-down-arrow"></i> Sell
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="stock-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h4 class="card-title">GOOG</h4>
                                                <p class="mb-1">Alphabet Inc. Class C</p>
                                                <span class="badge-sector">Technology</span>
                                            </div>
                                            <h4>$165.81 <span class="positive">+1.9%</span></h4>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="mb-1"><small>Shares: <strong>8</strong></small></p>
                                                <p class="mb-1"><small>Total Value: <strong>$1,326.48</strong></small></p>
                                                <p class="mb-1"><small>Avg. Cost: <strong>$145.60</strong></small></p>
                                                <p class="mb-0 positive"><small>Return: <strong>+13.9%</strong></small></p>
                                            </div>
                                            <div class="d-flex align-items-end">
                                                <button class="btn btn-outline-danger sell-btn" data-symbol="GOOG" data-price="165.81">
                                                    <i class="bi bi-graph-down-arrow"></i> Sell
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="stock-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h4 class="card-title">AMZN</h4>
                                                <p class="mb-1">Amazon.com Inc.</p>
                                                <span class="badge-sector">Consumer Cyclical</span>
                                            </div>
                                            <h4>$182.41 <span class="negative">-0.5%</span></h4>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="mb-1"><small>Shares: <strong>12</strong></small></p>
                                                <p class="mb-1"><small>Total Value: <strong>$2,188.92</strong></small></p>
                                                <p class="mb-1"><small>Avg. Cost: <strong>$160.25</strong></small></p>
                                                <p class="mb-0 positive"><small>Return: <strong>+13.8%</strong></small></p>
                                            </div>
                                            <div class="d-flex align-items-end">
                                                <button class="btn btn-outline-danger sell-btn" data-symbol="AMZN" data-price="182.41">
                                                    <i class="bi bi-graph-down-arrow"></i> Sell
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="stock-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h4 class="card-title">TSLA</h4>
                                                <p class="mb-1">Tesla, Inc.</p>
                                                <span class="badge-sector">Automotive</span>
                                            </div>
                                            <h4>$179.25 <span class="positive">+2.3%</span></h4>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="mb-1"><small>Shares: <strong>7</strong></small></p>
                                                <p class="mb-1"><small>Total Value: <strong>$1,254.75</strong></small></p>
                                                <p class="mb-1"><small>Avg. Cost: <strong>$190.40</strong></small></p>
                                                <p class="mb-0 negative"><small>Return: <strong>-5.9%</strong></small></p>
                                            </div>
                                            <div class="d-flex align-items-end">
                                                <button class="btn btn-outline-danger sell-btn" data-symbol="TSLA" data-price="179.25">
                                                    <i class="bi bi-graph-down-arrow"></i> Sell
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Analytics -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <h3><i class="bi bi-pie-chart-fill me-2"></i> Portfolio Analytics</h3>
                            
                            <!-- Sector Allocation Chart -->
                            <div class="mb-4">
                                <h5 class="mb-3 fw-light">Sector Allocation</h5>
                                <div class="chart-container">
                                    <canvas id="sectorChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Performance Chart -->
                            <div class="mb-4">
                                <h5 class="mb-3 fw-light">Portfolio Performance (Last 30 Days)</h5>
                                <div class="chart-container">
                                    <canvas id="performanceChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Risk Analysis -->
                            <div>
                                <h5 class="mb-3 fw-light">Risk Analysis</h5>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Portfolio Beta:</span>
                                    <span>1.12</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Volatility (30d):</span>
                                    <span>15.2%</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Sharpe Ratio:</span>
                                    <span>1.8</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Risk Level:</span>
                                    <span class="badge bg-warning">Moderate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Interface - Hidden by default -->
                <div id="chat-section" class="dashboard-card d-none">
                    <h3><i class="bi bi-chat-dots me-2"></i> Chat with Admin</h3>
                    <div class="row">
                        <!-- Admin List -->
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Admins</h5>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush" id="chat-users-list">
                                        <!-- Admin list will be dynamically populated -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Area -->
                        <div class="col-md-9">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0" id="chat-with">Select an admin to start chatting</h5>
                                </div>
                                <div class="card-body" style="height: 400px; overflow-y: auto;" id="chat-messages">
                                    <div class="text-center text-muted my-5">
                                        <i class="bi bi-chat-square-dots fs-1"></i>
                                        <p>Select an admin from the list to view your conversation.</p>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <form id="chat-form" class="d-none">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="chat-input" placeholder="Type your message...">
                                            <button class="btn btn-primary" type="submit">
                                                <i class="bi bi-send"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Base URL - update to match the backend router configuration
        const API_BASE_URL = 'http://localhost:8000/api';
        const WS_BASE_URL = 'ws://localhost:8000';
        
        // Store authentication token
        let authToken = localStorage.getItem('token');
        let userId = localStorage.getItem('user_id');

       // Chat message formatting
        function formatChatMessage(message, isSelf) {
            const date = new Date(message.timestamp);
            const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="chat-message mb-3 ${isSelf ? 'text-end' : ''}">
                    <div class="d-inline-block p-2 rounded ${isSelf ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 75%;">
                        <div>${message.content}</div>
                        <small class="text-${isSelf ? 'light' : 'muted'}">${formattedTime}</small>
                    </div>
                </div>
            `;
        }
        
        // Add chat CSS styles
        const style = document.createElement('style');
        style.textContent = `
            .client-list-item {
                cursor: pointer;
                position: relative;
            }
            .client-list-item:hover {
                background-color: #f8f9fa;
            }
            .client-list-item.active {
                background-color: #e9ecef;
            }
            .badge-unread {
                position: absolute;
                top: 8px;
                right: 8px;
            }
            .chat-separator {
                display: flex;
                align-items: center;
                text-align: center;
                margin: 15px 0;
            }
            .chat-separator::before, .chat-separator::after {
                content: '';
                flex: 1;
                border-bottom: 1px solid #dee2e6;
            }
            .chat-separator::before {
                margin-right: .5em;
            }
            .chat-separator::after {
                margin-left: .5em;
            }
            #fixed-chat-button {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 999;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
            }
        `;
        document.head.appendChild(style);
        
        // Helper function for API calls
        async function fetchAPI(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                    return null;
                }
                console.error(`API Error: ${response.status}`, await response.text());
                throw new Error(`API Error: ${response.status}`);
            }
            
            return await response.json();
        }

        // Check for authentication
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                console.log('No authentication token found, proceeding for testing');
                // Comment out for testing purposes:
                // window.location.href = 'login.html';
                // return;
            }
            
            // Initialize charts
            renderSectorChart();
            renderPerformanceChart();
            
            // Check for unread messages
            checkUnreadMessages();
            
            // Chat functionality
            const chatNavLink = document.getElementById('chat-nav-link');
            const dashboardCards = document.querySelectorAll('.dashboard-card');
            const chatSection = document.getElementById('chat-section');
            const chatUsersList = document.getElementById('chat-users-list');
            const chatMessages = document.getElementById('chat-messages');
            const chatWith = document.getElementById('chat-with');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const unreadBadge = document.getElementById('unread-badge');
            
            // Keep track of current active chat
            let currentChatUserId = null;
            let currentChatUsername = null;
            let socket = null;
            let userUnreadCounts = {};
            
            // Add a floating chat button for quick access
            const floatingButton = document.createElement('button');
            floatingButton.id = 'fixed-chat-button';
            floatingButton.className = 'btn btn-primary';
            floatingButton.innerHTML = '<i class="bi bi-chat-dots"></i>';
            floatingButton.setAttribute('data-bs-toggle', 'tooltip');
            floatingButton.setAttribute('data-bs-placement', 'left');
            floatingButton.setAttribute('title', 'Chat with Admin');
            document.body.appendChild(floatingButton);
            
            // Initialize tooltip
            new bootstrap.Tooltip(floatingButton);
            
            // Add floating button click handler
            floatingButton.addEventListener('click', function() {
                openChatInterface();
            });
            
            // Chat navigation
            chatNavLink.addEventListener('click', function(e) {
                e.preventDefault();
                openChatInterface();
            });
            
            // Function to open chat interface
            function openChatInterface() {
                // Hide all other dashboard cards and show chat section
                dashboardCards.forEach(card => {
                    if (card !== chatSection) {
                        card.classList.add('d-none');
                    }
                });
                chatSection.classList.remove('d-none');
                
                // Update active nav link
                document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                chatNavLink.classList.add('active');
                
                // Initialize chat if not already done
                loadChatUsers();
                if (!socket) {
                    connectWebSocket();
                }
            }
            
            // Test API connection to debug endpoint
            async function testApiConnection() {
                try {
                    const response = await fetchAPI('/ws/debug/token');
                    console.log('API connection test:', response);
                    return true;
                } catch (error) {
                    console.error('API connection test failed:', error);
                    return false;
                }
            }
            
            // Connect to WebSocket
            function connectWebSocket() {
                const token = authToken || 'mock_client_token';
                
                // Test API first
                testApiConnection().then(success => {
                    if (!success) {
                        console.error('API test failed, WebSocket might not work');
                    }
                    
                    // Close existing socket if any
                    if (socket) {
                        socket.close();
                    }
                    
                    console.log(`Connecting to WebSocket at: ${WS_BASE_URL}/ws/chat?token=${token.substring(0, 10)}...`);
                    socket = new WebSocket(`${WS_BASE_URL}/ws/chat?token=${token}`);
                    
                    socket.onopen = function(e) {
                        console.log('WebSocket connection established');
                    };
                    
                    socket.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        console.log('WebSocket message received:', data);
                        
                        if (data.error) {
                            console.error('WebSocket error message:', data.error, data.details);
                            return;
                        }
                        
                        if (data.connection_status === 'established') {
                            console.log('Connection debug info:', data);
                            return;
                        }
                        
                        if (data.type === 'chat') {
                            // Handle new chat message
                            if (data.sender_id === currentChatUserId) {
                                // If we're currently chatting with this user, show the message
                                addMessageToChat(data, false);
                                // Mark as read
                                sendReadReceipt(data.sender_id);
                            } else {
                                // Otherwise, update unread count
                                if (!userUnreadCounts[data.sender_id]) {
                                    userUnreadCounts[data.sender_id] = 0;
                                }
                                userUnreadCounts[data.sender_id]++;
                                
                                // Update UI to show unread count
                                updateUnreadBadges();
                                
                                // Show notification if possible
                                showChatNotification(data);
                            }
                        } else if (data.type === 'read_receipt') {
                            // Update UI if needed to show message was read
                            console.log('Message read by:', data.reader_username);
                        }
                    };
                    
                    socket.onclose = function(event) {
                        console.log('WebSocket connection closed:', event);
                        // Attempt to reconnect after delay
                        setTimeout(connectWebSocket, 5000);
                    };
                    
                    socket.onerror = function(error) {
                        console.error('WebSocket error:', error);
                    };
                });
            }
            
            // Show chat notification
            function showChatNotification(message) {
                // Check if browser supports notifications
                if (!("Notification" in window)) {
                    return;
                }
                
                // Request permission if needed
                if (Notification.permission === "granted") {
                    const notification = new Notification("New message from admin", {
                        body: message.content.substring(0, 50) + (message.content.length > 50 ? "..." : ""),
                        icon: "/favicon.ico"
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        openChatInterface();
                        loadChatHistory(message.sender_id, message.sender_username || "Admin");
                    };
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(function (permission) {
                        if (permission === "granted") {
                            showChatNotification(message);
                        }
                    });
                }
            }
            
            // Send a message
            function sendMessage(content) {
                if (!socket || socket.readyState !== WebSocket.OPEN || !currentChatUserId) {
                    alert('Chat connection not available');
                    return;
                }
                
                const message = {
                    type: 'chat',
                    receiver_id: currentChatUserId,
                    content: content
                };
                
                socket.send(JSON.stringify(message));
                
                // Optimistically add message to chat
                const selfMessage = {
                    id: Date.now(), // Temporary ID
                    sender_id: userId || 'self', // Will be replaced by actual ID from server
                    content: content,
                    timestamp: new Date().toISOString(),
                    is_read: 0
                };
                addMessageToChat(selfMessage, true);
            }
            
            // Mark messages as read
            function sendReadReceipt(senderId) {
                // Via WebSocket
                if (socket && socket.readyState === WebSocket.OPEN) {
                    const message = {
                        type: 'read',
                        sender_id: senderId
                    };
                    
                    socket.send(JSON.stringify(message));
                }
                
                // Also via REST API to ensure it's recorded
                fetchAPI(`/ws/chat/read/${senderId}`, {
                    method: 'PUT'
                }).catch(error => {
                    console.error('Error marking messages as read:', error);
                });
                
                // Reset unread count for this user
                userUnreadCounts[senderId] = 0;
                updateUnreadBadges();
            }
            
            // Add message to chat UI
            function addMessageToChat(message, isSelf) {
                const messageHtml = formatChatMessage(message, isSelf);
                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Update unread badges
            function updateUnreadBadges() {
                // Update global unread badge
                const totalUnread = Object.values(userUnreadCounts).reduce((sum, count) => sum + count, 0);
                if (totalUnread > 0) {
                    unreadBadge.textContent = totalUnread;
                    unreadBadge.classList.remove('d-none');
                    
                    // Also update the floating button with a badge
                    const floatingButton = document.getElementById('fixed-chat-button');
                    if (floatingButton) {
                        if (!floatingButton.querySelector('.badge')) {
                            const badge = document.createElement('span');
                            badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                            badge.textContent = totalUnread;
                            floatingButton.appendChild(badge);
                        } else {
                            floatingButton.querySelector('.badge').textContent = totalUnread;
                        }
                    }
                } else {
                    unreadBadge.classList.add('d-none');
                    
                    // Remove badge from floating button
                    const floatingButton = document.getElementById('fixed-chat-button');
                    if (floatingButton && floatingButton.querySelector('.badge')) {
                        floatingButton.querySelector('.badge').remove();
                    }
                }
                
                // Update individual user badges
                document.querySelectorAll('.client-list-item').forEach(item => {
                    const userId = item.getAttribute('data-id');
                    const badgeEl = item.querySelector('.badge-unread');
                    
                    if (badgeEl) {
                        const unreadCount = userUnreadCounts[userId] || 0;
                        if (unreadCount > 0) {
                            badgeEl.textContent = unreadCount;
                            badgeEl.classList.remove('d-none');
                        } else {
                            badgeEl.classList.add('d-none');
                        }
                    }
                });
            }
            
            // Check for unread messages
            async function checkUnreadMessages() {
                try {
                    const response = await fetchAPI('/ws/chat/unread/count');
                    if (response && response.unread_count > 0) {
                        userUnreadCounts = {}; // Reset counts
                        
                        // Get detailed unread messages
                        const unreadDetail = await fetchAPI('/ws/chat/unread');
                        
                        // Set counts by sender
                        unreadDetail.unread_by_sender.forEach(sender => {
                            userUnreadCounts[sender.sender_id] = sender.count;
                        });
                        
                        updateUnreadBadges();
                    }
                } catch (error) {
                    console.error('Error checking unread messages:', error);
                }
            }
            
            // Load chat users (admins)
            async function loadChatUsers() {
                try {
                    // First check API connectivity
                    await testApiConnection();
                    
                    // Fetch admin users from the API
                    const partners = await fetchAPI('/ws/chat/partners');
                    console.log('Chat partners loaded:', partners);
                    
                    // Clear the list
                    chatUsersList.innerHTML = '';
                    
                    if (partners.length === 0) {
                        chatUsersList.innerHTML = '<li class="list-group-item text-center">No admins available</li>';
                        return;
                    }
                    
                    // Add each admin to the list
                    partners.forEach(partner => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item client-list-item';
                        listItem.setAttribute('data-id', partner.id);
                        listItem.innerHTML = `
                            <div class="d-flex align-items-center py-1">
                                <div class="me-2">
                                    <i class="bi bi-person-circle fs-5"></i>
                                </div>
                                <div>
                                    ${partner.username}
                                </div>
                                <span class="badge bg-danger badge-unread rounded-pill d-none">0</span>
                            </div>
                        `;
                        
                        // Add click event to load chat history
                        listItem.addEventListener('click', function() {
                            loadChatHistory(partner.id, partner.username);
                        });
                        
                        chatUsersList.appendChild(listItem);
                    });
                    
                    // Update any unread badges
                    updateUnreadBadges();
                    
                    // Automatically select the first admin if there's only one
                    if (partners.length === 1) {
                        loadChatHistory(partners[0].id, partners[0].username);
                    }
                    
                } catch (error) {
                    console.error('Error loading chat partners:', error);
                    chatUsersList.innerHTML = '<li class="list-group-item text-danger">Error loading admins</li>';
                }
            }
            
            // Load chat history with a user
            async function loadChatHistory(userId, username) {
                try {
                    // Set current chat user
                    currentChatUserId = userId;
                    currentChatUsername = username;
                    
                    // Update UI
                    chatWith.textContent = `Chat with ${username}`;
                    chatForm.classList.remove('d-none');
                    chatMessages.innerHTML = '<div class="text-center my-3"><small class="text-muted">Loading messages...</small></div>';
                    
                    // Update active user in the list
                    document.querySelectorAll('.client-list-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-id') == userId) {
                            item.classList.add('active');
                        }
                    });
                    
                    // Fetch chat history from API
                    const messages = await fetchAPI(`/ws/chat/history/${userId}`);
                    
                    // Clear existing messages
                    chatMessages.innerHTML = '';
                    
                    if (messages.length === 0) {
                        chatMessages.innerHTML = `
                            <div class="text-center my-5">
                                <i class="bi bi-chat-square-dots fs-1 text-muted"></i>
                                <p class="text-muted">No messages yet. Start a conversation!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Add date separator for first message
                    if (messages.length > 0) {
                        const firstDate = new Date(messages[0].timestamp);
                        const dateStr = firstDate.toLocaleDateString();
                        chatMessages.innerHTML = `<div class="chat-separator"><span class="mx-2 text-muted small">${dateStr}</span></div>`;
                    }
                    
                    // Display messages
                    let currentDate = '';
                    messages.forEach(message => {
                        // Check if we need a date separator
                        const messageDate = new Date(message.timestamp);
                        const dateStr = messageDate.toLocaleDateString();
                        
                        if (dateStr !== currentDate) {
                            currentDate = dateStr;
                            if (messages.indexOf(message) > 0) {
                                chatMessages.insertAdjacentHTML('beforeend', 
                                    `<div class="chat-separator"><span class="mx-2 text-muted small">${dateStr}</span></div>`
                                );
                            }
                        }
                        
                        // Determine if this is our message
                        const isSelf = message.sender_id == (userId || 'self');
                        addMessageToChat(message, !isSelf); // Note: we invert isSelf because it's from our perspective
                    });
                    
                    // Mark all unread messages as read
                    sendReadReceipt(userId);
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    chatMessages.innerHTML = '<div class="text-center my-3"><small class="text-danger">Error loading messages</small></div>';
                }
            }
            
            // Chat form submission
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    sendMessage(message);
                    chatInput.value = '';
                }
            });
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_id');
                window.location.href = 'login.html';
            });
            
            // Handle sell buttons
            document.querySelectorAll('.sell-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const symbol = this.getAttribute('data-symbol');
                    const price = this.getAttribute('data-price');
                    addToCart(symbol, price, 'sell');
                });
            });
            
            // Function to add to cart
            async function addToCart(symbol, price, trade_type) {
                try {
                    // In a real app, this would be an API call
                    // For demo purposes, just show an alert
                    alert(`Added ${symbol} to cart for ${trade_type} at $${price}`);
                    
                    // Update cart badge
                    const cartBadge = document.getElementById('cart-badge');
                    cartBadge.textContent = parseInt(cartBadge.textContent) + 1;
                } catch (error) {
                    alert('Error adding to cart: ' + error.message);
                }
            }
            
            // Check for unread messages periodically
            setInterval(checkUnreadMessages, 30000);
        });
        
        function renderSectorChart() {
            const ctx = document.getElementById('sectorChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Technology', 'Consumer Cyclical', 'Automotive', 'Healthcare'],
                    datasets: [{
                        data: [62, 20, 12, 6],
                        backgroundColor: [
                            '#0d6efd',
                            '#6f42c1',
                            '#fd7e14',
                            '#20c997'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Generate last 30 days dates
            const dates = [];
            const data = [];
            const now = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(now.getDate() - i);
                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                // Generate random performance data with upward trend
                const baseValue = 40000;
                const dayOffset = (Math.random() * 2000) - 800;
                const trendValue = i * 100;
                data.push(baseValue + trendValue + dayOffset);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Portfolio Value ($)',
                        data: data,
                        fill: {
                            target: 'origin',
                            above: 'rgba(13, 110, 253, 0.1)',
                        },
                        borderColor: '#0d6efd',
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#0d6efd',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 7
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>